<!--
	Ideally these elements aren't created until it's confirmed that the 
	client supports video/camera, but for the sake of illustrating the 
	elements involved, they are created with markup (not JavaScript)
-->
<script src="jsfeat.js"></script>
<body>
<video id="video" width="640" height="480" style="display:none" autoplay></video>
<canvas id="canvas" width="640" height="480"></canvas>

<script src="/socket.io/socket.io.js"></script>
<script>
window.onload = function() {
    var socket = io();

    "use strict";
    // lets do some fun
    var video = document.getElementById('video');
    var canvas = document.getElementById('canvas');
    canvas.width = 640;
    canvas.height = 480;
    var ctx = canvas.getContext('2d');
    
    if(navigator.mediaDevices && navigator.mediaDevices.getUserMedia)
	    // Not adding `{ audio: true }` since we only want video now
	    navigator.mediaDevices.getUserMedia({ video: true }).then(function(stream) {
	        video.src = window.URL.createObjectURL(stream);
            requestAnimationFrame(draw);
        });

    function draw(){
        requestAnimationFrame(draw);
        if (video.readyState === video.HAVE_ENOUGH_DATA){
            ctx.drawImage(video, 0, 0, 640, 480);

            if(boxData){
                ctx.strokeStyle = "rgb(0,255,0)";
                ctx.beginPath();
                ctx.moveTo(boxData[0].x,boxData[0].y);
                ctx.lineTo(boxData[1].x,boxData[1].y);
                ctx.lineTo(boxData[2].x,boxData[2].y);
                ctx.lineTo(boxData[3].x,boxData[3].y);
                ctx.lineTo(boxData[0].x,boxData[0].y);
                ctx.lineWidth=4;
                ctx.stroke();
            }

            if(pointsData){
                pointsData.forEach(function(val){
                    if(val.correct) {
                        ctx.fillStyle = "rgb(0,255,0)";
                    } else {
                        ctx.fillStyle = "rgb(255,0,0)";
                    }
                    ctx.fillRect(val.x-1,val.y-1,3,3);
                    ctx.stroke();
                })
            }
        }
    }

    var boxData;
    var pointsData;

    socket.on('requestImage', function(){
        var imageData = ctx.getImageData(0, 0, 640, 480);
        socket.emit('processImage', imageData.data);
    });

    socket.on('boundingBox', function(data){
        boxData = data;
    })

    socket.on('points', function(data){
        pointsData = data;
    })
    
    window.onunload = function() {
        video.pause();
        video.src=null;
    };
}
</script>
</body>